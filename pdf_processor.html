<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Detail Processor - Split & Rename</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e9ecef;
            padding: 20px 0;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #495057;
        }

        .card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }

        .card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: box-shadow 0.2s ease;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #212529;
            margin-bottom: 20px;
        }

        .upload-area {
            border: 2px dashed #ced4da;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #f8f9fa;
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: #007bff;
            background: #f0f8ff;
        }

        .upload-area h3 {
            color: #495057;
            font-size: 1.1rem;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .upload-area p {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover:not(:disabled) {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover:not(:disabled) {
            background: #1e7e34;
        }

        .btn-download {
            background: #6f42c1;
            font-size: 0.85rem;
            padding: 8px 16px;
        }

        .btn-download:hover:not(:disabled) {
            background: #5a2d91;
        }

        .status {
            margin: 15px 0;
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
            color: #495057;
            transition: border-color 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .radio-option:hover {
            background: #f8f9fa;
            border-color: #ced4da;
        }

        .radio-option input[type="radio"] {
            margin-right: 12px;
            transform: scale(1.1);
        }

        .radio-option.selected {
            border-color: #007bff;
            background: #f0f8ff;
        }

        .pattern-input-section {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .file-info {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
        }

        .file-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .detail-value {
            font-size: 0.95rem;
            color: #212529;
            font-weight: 500;
        }

        .page-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .page-title {
            font-size: 1rem;
            font-weight: 600;
            color: #212529;
        }

        .extracted-text {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            color: #495057;
            max-height: 120px;
            overflow-y: auto;
            margin: 15px 0;
            word-break: break-word;
        }

        .filename-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 0.9rem;
            margin-bottom: 15px;
            transition: border-color 0.2s ease;
        }

        .filename-input:focus {
            outline: none;
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }

        .file-size-info {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 15px;
        }

        .debug-panel {
            background: #343a40;
            color: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .debug-panel div {
            margin-bottom: 2px;
            padding: 2px 0;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .file-details {
                grid-template-columns: 1fr;
            }
            
            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>ðŸ“„ PDF Detail Processor</h1>
        </div>
    </div>

    <div class="container">
        <!-- Upload Section -->
        <div class="card">
            <div class="card-title">Upload PDF File</div>
            <div id="uploadArea" class="upload-area">
                <h3>Click here or drop your PDF file</h3>
                <p>Maximum file size: 50MB</p>
                <input type="file" id="fileInput" style="display: none;" accept=".pdf">
            </div>

            <div id="status" class="status"></div>
            
            <div id="fileInfo" class="file-info hidden">
                <div class="form-label">File Information</div>
                <div id="fileDetails" class="file-details"></div>
            </div>

            <button id="processBtn" class="btn hidden" onclick="processPDF()">Process PDF</button>
        </div>

        <!-- Naming Strategy -->
        <div id="namingCard" class="card hidden">
            <div class="card-title">Choose Naming Strategy</div>
            
            <div class="radio-group">
                <label class="radio-option" onclick="selectOption(this)">
                    <input type="radio" name="namingStrategy" value="custom-identifier" checked>
                    <div>
                        <strong>Custom Pattern</strong>
                        <div style="font-size: 0.85rem; color: #6c757d; margin-top: 4px;">
                            Search for your specific pattern + numbers (Recommended)
                        </div>
                    </div>
                </label>
                
                <div class="pattern-input-section">
                    <div class="form-group">
                        <label class="form-label">Pattern</label>
                        <input type="text" id="identifierPattern" class="form-input" 
                               placeholder="Enter your pattern (e.g., L, ID, REF)" value="">
                        <div style="font-size: 0.8rem; color: #6c757d; margin-top: 8px;">
                            Examples: Pattern "L" finds L5, L8-a, L123 but ignores words like "Loopdeur"
                        </div>
                    </div>
                </div>

                <label class="radio-option" onclick="selectOption(this)">
                    <input type="radio" name="namingStrategy" value="page-number">
                    <div>
                        <strong>Page Number</strong>
                        <div style="font-size: 0.85rem; color: #6c757d; margin-top: 4px;">
                            Simple page-1.pdf, page-2.pdf, etc.
                        </div>
                    </div>
                </label>
            </div>

            <div style="margin-top: 25px; text-align: right;">
                <button id="analyzeBtn" class="btn btn-success" onclick="analyzePages()">
                    Analyze Pages
                </button>
            </div>
        </div>

        <!-- Results -->
        <div id="results" class="card hidden">
            <div class="card-title">Split PDF Files</div>
            <div id="pagesContainer"></div>
            <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #e9ecef; text-align: right;">
                <button onclick="downloadAllFiles()" class="btn" style="font-size: 0.9rem; padding: 12px 24px;">
                    Download All as ZIP
                </button>
            </div>
        </div>

        <!-- Debug Panel -->
        <div id="debugCard" class="card hidden">
            <div class="card-title">Debug Log</div>
            <div id="debugLog" class="debug-panel"></div>
            <div style="margin-top: 15px; text-align: right;">
                <button onclick="clearDebug()" class="btn" style="background: #6c757d; font-size: 0.8rem; padding: 8px 16px;">
                    Clear Log
                </button>
            </div>
        </div>
    </div>

    <script>
        // Initialize PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Global variables
        let currentFile = null;
        let currentPdf = null;
        let pdfPages = [];

        function debugLog(message) {
            const debugCard = document.getElementById('debugCard');
            const debugLogEl = document.getElementById('debugLog');
            
            debugCard.classList.remove('hidden');
            
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${timestamp}] ${message}`;
            debugLogEl.appendChild(logEntry);
            debugLogEl.scrollTop = debugLogEl.scrollHeight;
            
            console.log(`[DEBUG] ${message}`);
        }

        function clearDebug() {
            document.getElementById('debugLog').innerHTML = '';
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }

        function selectOption(element) {
            document.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
        }

        function extractCustomIdentifier(text, pattern) {
            if (!text || !pattern) return null;
            
            const words = text.split(/\s+/);
            
            for (const word of words) {
                const clean = word.replace(/[^\w\-]/g, '');
                
                if (clean.toLowerCase().startsWith(pattern.toLowerCase())) {
                    const after = clean.substring(pattern.length);
                    
                    if (after.length > 0) {
                        const firstChar = after[0];
                        
                        if (firstChar >= '0' && firstChar <= '9') {
                            if (clean.length > pattern.length + 5) {
                                const remaining = after.substring(1);
                                if (/^[a-zA-Z]{4,}/.test(remaining)) {
                                    continue;
                                }
                            }
                            return clean;
                        }
                    }
                }
            }
            return null;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('PDF Detail Processor initialized');
            
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.onclick = () => fileInput.click();
            
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (file.type === 'application/pdf') {
                        handleFile(file);
                    } else {
                        showStatus('Please select a PDF file', 'error');
                    }
                }
            };

            uploadArea.ondragover = function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            };

            uploadArea.ondragleave = function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            };

            uploadArea.ondrop = function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type === 'application/pdf') {
                        handleFile(file);
                    } else {
                        showStatus('Please drop a PDF file', 'error');
                    }
                }
            };

            document.querySelector('.radio-option').classList.add('selected');
            showStatus('Ready! Upload a PDF file to begin.', 'success');
        });

        function handleFile(file) {
            debugLog(`File selected: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
            
            if (file.size > 50 * 1024 * 1024) {
                showStatus('File too large. Maximum size is 50MB.', 'error');
                return;
            }
            
            currentFile = file;
            
            const fileInfo = document.getElementById('fileInfo');
            const fileDetails = document.getElementById('fileDetails');
            
            fileDetails.innerHTML = `
                <div class="detail-item">
                    <span class="detail-label">Name</span>
                    <span class="detail-value">${file.name}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Size</span>
                    <span class="detail-value">${(file.size / 1024 / 1024).toFixed(2)} MB</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Type</span>
                    <span class="detail-value">${file.type}</span>
                </div>
            `;
            
            fileInfo.classList.remove('hidden');
            document.getElementById('processBtn').classList.remove('hidden');
            
            showStatus('File loaded! Click "Process PDF" to continue.', 'success');
        }

        async function processPDF() {
            if (!currentFile) return;
            
            try {
                debugLog('Processing PDF...');
                const processBtn = document.getElementById('processBtn');
                processBtn.disabled = true;
                processBtn.textContent = 'Loading PDF...';

                const arrayBuffer = await currentFile.arrayBuffer();
                currentPdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                
                debugLog(`PDF loaded successfully: ${currentPdf.numPages} pages`);
                
                document.getElementById('fileDetails').innerHTML += `
                    <div class="detail-item">
                        <span class="detail-label">Pages</span>
                        <span class="detail-value">${currentPdf.numPages}</span>
                    </div>
                `;
                
                document.getElementById('namingCard').classList.remove('hidden');
                
                showStatus(`PDF loaded! Found ${currentPdf.numPages} pages. Choose naming strategy below.`, 'success');
                
            } catch (error) {
                debugLog(`Error loading PDF: ${error.message}`);
                showStatus('Error loading PDF. Please check if the file is valid.', 'error');
                console.error('PDF processing error:', error);
            } finally {
                const processBtn = document.getElementById('processBtn');
                processBtn.disabled = false;
                processBtn.textContent = 'Process PDF';
            }
        }

        async function analyzePages() {
            if (!currentPdf) return;
            
            try {
                debugLog('Starting page analysis...');
                const analyzeBtn = document.getElementById('analyzeBtn');
                analyzeBtn.disabled = true;
                analyzeBtn.textContent = 'Analyzing Pages...';

                const strategy = document.querySelector('input[name="namingStrategy"]:checked').value;
                const pattern = document.getElementById('identifierPattern').value.trim();
                
                if (strategy === 'custom-identifier' && !pattern) {
                    showStatus('Please enter a pattern for custom identifier search', 'error');
                    analyzeBtn.disabled = false;
                    analyzeBtn.textContent = 'Analyze Pages';
                    return;
                }
                
                pdfPages = [];
                let processedPages = 0;
                
                for (let pageNum = 1; pageNum <= currentPdf.numPages; pageNum++) {
                    try {
                        debugLog(`Processing page ${pageNum} of ${currentPdf.numPages}`);
                        showStatus(`Processing page ${pageNum} of ${currentPdf.numPages}...`, 'success');
                        
                        const page = await currentPdf.getPage(pageNum);
                        const textContent = await page.getTextContent();
                        const text = textContent.items.map(item => item.str).join(' ');
                        
                        let filename;
                        if (strategy === 'custom-identifier' && pattern) {
                            const identifier = extractCustomIdentifier(text, pattern);
                            filename = identifier || `page-${pageNum}`;
                            debugLog(`Page ${pageNum}: Pattern "${pattern}" found: ${identifier || 'none'}`);
                        } else {
                            filename = `page-${pageNum}`;
                        }
                        
                        // Create optimized PDF
                        const pdfDoc = await PDFLib.PDFDocument.create();
                        
                        try {
                            const originalPdfDoc = await PDFLib.PDFDocument.load(await currentFile.arrayBuffer());
                            const [copiedPage] = await pdfDoc.copyPages(originalPdfDoc, [pageNum - 1]);
                            pdfDoc.addPage(copiedPage);
                            debugLog(`Page ${pageNum} copied as vector`);
                        } catch (vectorError) {
                            debugLog(`Vector copy failed for page ${pageNum}, using raster`);
                            
                            const viewport = page.getViewport({ scale: 3.0 });
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.width = viewport.width;
                            canvas.height = viewport.height;
                            
                            context.imageSmoothingEnabled = false;
                            
                            await page.render({
                                canvasContext: context,
                                viewport: viewport,
                                intent: 'print'
                            }).promise;
                            
                            const imageData = canvas.toDataURL('image/jpeg', 0.92);
                            const image = await pdfDoc.embedJpg(imageData);
                            
                            const pageWidth = viewport.width * 0.75;
                            const pageHeight = viewport.height * 0.75;
                            
                            const newPage = pdfDoc.addPage([pageWidth, pageHeight]);
                            newPage.drawImage(image, {
                                x: 0,
                                y: 0,
                                width: pageWidth,
                                height: pageHeight
                            });
                        }
                        
                        const pdfBytes = await pdfDoc.save({
                            useObjectStreams: false,
                            addDefaultPage: false
                        });
                        const pdfBlob = new Blob([pdfBytes], { type: 'application/pdf' });
                        
                        debugLog(`Page ${pageNum} processed: ${(pdfBlob.size / 1024).toFixed(1)} KB`);
                        
                        pdfPages.push({
                            pageNum,
                            text: text.substring(0, 500),
                            filename,
                            pdfBlob
                        });
                        
                        processedPages++;
                        
                    } catch (pageError) {
                        debugLog(`Error processing page ${pageNum}: ${pageError.message}`);
                    }
                }
                
                if (processedPages > 0) {
                    displayResults();
                    showStatus(`Successfully processed ${processedPages} pages!`, 'success');
                } else {
                    showStatus('No pages could be processed', 'error');
                }
                
            } catch (error) {
                debugLog(`Error during analysis: ${error.message}`);
                showStatus('Error analyzing pages. Please try again.', 'error');
                console.error('Analysis error:', error);
            } finally {
                const analyzeBtn = document.getElementById('analyzeBtn');
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'Analyze Pages';
            }
        }

        function displayResults() {
            const container = document.getElementById('pagesContainer');
            container.innerHTML = '';
            
            pdfPages.forEach((page, index) => {
                const pageDiv = document.createElement('div');
                pageDiv.className = 'page-item';
                
                const previewText = page.text.length > 200 ? 
                    page.text.substring(0, 200) + '...' : page.text;
                
                pageDiv.innerHTML = `
                    <div class="page-header">
                        <div class="page-title">Page ${page.pageNum}: ${page.filename}.pdf</div>
                        <button onclick="downloadSingle(${index})" class="btn btn-download">
                            Download
                        </button>
                    </div>
                    
                    <div class="extracted-text">${previewText || 'No text found'}</div>
                    
                    <div class="file-size-info">
                        <strong>File size:</strong> ${(page.pdfBlob.size / 1024).toFixed(1)} KB
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Filename</label>
                        <input type="text" class="filename-input" value="${page.filename}" data-index="${index}" 
                               placeholder="Edit filename (without .pdf extension)">
                    </div>
                `;
                container.appendChild(pageDiv);
            });
            
            document.getElementById('results').classList.remove('hidden');
            debugLog(`Results displayed for ${pdfPages.length} pages`);
        }

        function downloadSingle(index) {
            try {
                const page = pdfPages[index];
                const input = document.querySelector(`input[data-index="${index}"]`);
                let filename = input.value.trim() || page.filename;
                
                filename = filename.replace(/\.pdf$/i, '');
                filename = filename.replace(/[<>:"/\\|?*]/g, '-');
                
                const url = URL.createObjectURL(page.pdfBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                debugLog(`Downloaded: ${filename}.pdf`);
                showStatus(`Downloaded: ${filename}.pdf`, 'success');
            } catch (error) {
                debugLog(`Error downloading file: ${error.message}`);
                showStatus('Error downloading file', 'error');
            }
        }

        async function downloadAllFiles() {
            try {
                debugLog('Creating ZIP file with all PDFs...');
                
                if (!pdfPages || pdfPages.length === 0) {
                    showStatus('No files to download', 'error');
                    return;
                }
                
                const downloadBtn = document.querySelector('button[onclick="downloadAllFiles()"]');
                if (downloadBtn) {
                    downloadBtn.disabled = true;
                    downloadBtn.textContent = 'Creating ZIP...';
                }
                
                if (typeof JSZip === 'undefined') {
                    debugLog('JSZip library not loaded');
                    showStatus('ZIP library not loaded. Please refresh the page.', 'error');
                    return;
                }
                
                const zip = new JSZip();
                let addedFiles = 0;
                
                for (let i = 0; i < pdfPages.length; i++) {
                    try {
                        const page = pdfPages[i];
                        const input = document.querySelector(`input[data-index="${i}"]`);
                        
                        let filename = page.filename;
                        if (input && input.value.trim()) {
                            filename = input.value.trim();
                        }
                        
                        filename = filename.replace(/\.pdf$/i, '');
                        filename = filename.replace(/[<>:"/\\|?*]/g, '-');
                        const finalFilename = `${filename}.pdf`;
                        
                        if (page.pdfBlob && page.pdfBlob.size > 0) {
                            zip.file(finalFilename, page.pdfBlob);
                            addedFiles++;
                            showStatus(`Adding to ZIP: ${addedFiles}/${pdfPages.length} files...`, 'success');
                        }
                        
                    } catch (error) {
                        debugLog(`Error adding file ${i + 1} to ZIP: ${error.message}`);
                    }
                }
                
                if (addedFiles === 0) {
                    showStatus('No valid files to create ZIP', 'error');
                    return;
                }
                
                debugLog(`Generating ZIP with ${addedFiles} files...`);
                showStatus('Generating ZIP file...', 'success');
                
                const zipBlob = await zip.generateAsync({
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 6 }
                });
                
                const originalName = currentFile.name.replace('.pdf', '');
                const zipFilename = `${originalName}-split-pages.zip`;
                
                const zipUrl = URL.createObjectURL(zipBlob);
                const downloadLink = document.createElement('a');
                downloadLink.href = zipUrl;
                downloadLink.download = zipFilename;
                downloadLink.style.display = 'none';
                
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                
                setTimeout(() => URL.revokeObjectURL(zipUrl), 3000);
                
                debugLog(`ZIP download complete: ${zipFilename}`);
                showStatus(`ZIP downloaded: ${zipFilename} with ${addedFiles} files`, 'success');
                
            } catch (error) {
                debugLog(`Error creating ZIP: ${error.message}`);
                showStatus(`ZIP creation failed: ${error.message}`, 'error');
                console.error('ZIP creation error:', error);
            } finally {
                const downloadBtn = document.querySelector('button[onclick="downloadAllFiles()"]');
                if (downloadBtn) {
                    downloadBtn.disabled = false;
                    downloadBtn.textContent = 'Download All as ZIP';
                }
            }
        }
    </script>
</body>
</html>
